---
title: 'ruby-htslib'
author:
  - 'kojix2'
  - 'Naohisa Goto'
date: 24 May 2022
bibliography: ruby-htslib.bib
header-includes:
  - \usepackage[margin=1in]{geometry}
---

# Summary

Ruby-htslib is the Ruby bindings to HTSlib [@bonfield2021], a C library for processing high throughput sequencing (HTS) data. It will provide APIs to read and write file formats such as SAM/BAM and VCF/BCF.

* Code of ruby-htslib : [https://github.com/kojix2/ruby-htslib](https://github.com/kojix2/ruby-htslib)

# Statement of need

The Ruby language is an object-oriented programming language. It is a general-purpose programming language used primarily in the field of web application development. Ruby has also been used in the bioinformatics field, and the BioRuby project [@goto2010] provides access to many file formats.

In recent years, the volume of biological data generated by sequencing technologies has increased. file formats such as SAM, BAM, CRAM, VCF, and BCF have become widely used with the spread of next-generation sequencers. SAM, BAM, and CRAM are file formats for alignments. VCF and BCF are file formats for variants. The specifications for these file formats are defined in [hts-specs](http://samtools.github.io/hts-specs/). Samtools and Bcftools [@danecek2021] were created to manipulate HTS files. And the core part of samtools became a library called HTSlib. We can use HTSLib [@bonfield2021] to read, write and query HTS files.

However, the ways to manipulate HTS files from the Ruby language have been limited. BioRuby does not have a module to work with HTS files. Bio-Samtools [@etherington2015] was originally developed as a samtools binding. However, when samtools separated htslib, the bindings stopped working. Now it uses open3 to call samtools directly from standard streams.

Ruby-htslib is a binding for htslib. It provides access to comprehensive HTS files from the Ruby language. This allows the Ruby language to analyze genomes and create applications.

# Implementation

ruby-htslib was implemented using Ruby-FFI. Reduced memory usage by the method used in the hts-nim [@pedersen2018].

# Benchmark


# Examples

Reading bam file.

```ruby
require 'htslib'

bam = HTS::Bam.open("test/fixtures/moo.bam")

bam.each do |r|
  pp name: r.qname,
     flag: r.flag,
     chrm: r.chrom,
     strt: r.pos + 1,
     mapq: r.mapq,
     cigr: r.cigar.to_s,
     mchr: r.mate_chrom,
     mpos: r.mpos + 1,
     isiz: r.isize,
     seqs: r.seq,
     qual: r.qual_string,
     MC:   r.aux("MC")
end

bam.close
```

Reading Bcf file.

```ruby
bcf = HTS::Bcf.open("b.bcf")

bcf.each do |r|
  p chrom:  r.chrom,
    pos:    r.pos,
    id:     r.id,
    qual:   r.qual.round(2),
    ref:    r.ref,
    alt:    r.alt,
    filter: r.filter,
    info:   r.info.to_h,
    format: r.format.to_h
end

bcf.close
```

## htsgrid

We present a very simple genome browser as an example of the use of Ruby-htslib.

## bam-filter and bcf-filter

Using eval allows for very flexible sorting.

# Reference
